# 개요
- 캐시란, 데이터를 임시로 복사해두는 Storage 계층입니다.
- 작은 부하로 API 응답을 빠르게 처리하는 것이 캐싱의 목적입니다.
- cache 사용의 사례로는 `DNS, CPU, CDN`가 있습니다.
---

# 캐싱 전략
    
## 캐싱 전략 선택 시, 고려할 점
- 시스템이 쓰기 무겁고 덜 자주 읽히는가? (예 : 시간 기반 로그)
- 데이터를 한 번 쓰고 여러 번 읽는가? (예 : 사용자 프로필)
- 반환되는 데이터는 항상 고유한가? (예 : 검색어)

## 캐싱 전략 주요 방식
### 캐시 읽기 전략 (Read Cache Strategy)
1. **Cache Aside**
    - 데이터를 찾을때 우선 캐시에 저장된 데이터가 있는지 우선적으로 확인하는 전략으로, 만일 캐시에 데이터가 없으면 DB에서 조회함.
    - 반복적인 읽기가 많고 변경 가능성이 있는 데이터에 적합함.
    - Redis가 가장 많이 쓰이며, 캐시 분리를 사용하였기 때문에 캐시 오류에 대해 탄력적임.
      즉, 캐시 클러스터가 다운되어도 시스템 전체의 오류로 가지 않음.
    - 사용자 프로필 또는 API 응답 등
2. **Read Through** : 캐시에서만 데이터를 읽어오는 전략.
    - Cache Aside 와 비슷하지만 데이터 동기화를 라이브러리 또는 캐시 제공자에게 위임하는 방식이라는 차이가 있으므로, 전체적으로 속도가 느림.
    - 거의 변하지 않는 정적 또는 준정적 데이터에 적합함.
    - CDN 콘텐츠 또는 추천 결과 등

### 캐시 쓰기 전략 (Write Cache Strategy)
1. **Write Through**
    - 데이터베이스와 Cache에 동시에 데이터를 저장하는 전략.
    - 데이터 유실이 발생하면 안되는 상황에 적합함.
    - 데이터를 저장할 때, 먼저 캐시에 저장하고 바로 DB에 저장함.(건 by 건으로 저장)
2. **Write Around**
    - 데이터베이스에만 데이터가 저장되고, 읽은 데이터만 캐시에 저장하는 전략,
    - Write-Around는 Read-Through와 결합 될 수 있으며, Cache-Aside와도 결합될 수 있음.
    - 데이터가 한 번 쓰여지고, 덜 자주 읽히거나 읽지 않는 상황에서 좋은 성능을 제공함.
    - 실시간 로그 또는 채팅방 메시지 등
3. **Write Back**
    - 데이터를 저장할때 DB에 바로 저장하지않고, 캐시에 모아서 일정 주기 배치 작업(스케쥴링)을 통해 DB에 반영하는 전략.
    - 쓰기가 빈번하면서 읽기를 할 때, 많은 양의 리소스가 소모되는 서비스에 적합함.

## 이커머스 서비스에서의 캐싱 전략
1. 상위 상품조회 서비스
   - 현재 여러 테이블을 조인한 쿼리를 통해 상위 상품조회 서비스를 제공하고 있습니다.
   - 상위 상품 조회 서비스는 기준 일자가 변하지 않는 이상, 고정된 데이터이기 때문에 캐싱 전략이 유효합니다.
   - 이에, Cache Aside 전략을 통해 캐시된 데이터를 가져오고, 그 외에는 DB에서 조회하도록 할 수 있습니다.
---

# 캐시 스탬피드 현상

## 원인
- 캐시를 사용하는 경우, 만료 시간을 설정하는 것이 필수적입니다.
- 모든 키에 대해 만료 시간을 동일하게 설정하는 경우, 대규모 트래픽 환경에서 캐시 스탬피드(cache stampede) 현상이 발생할 수 있습니다.
- 많은 요청이 동시에 캐시 만료를 인식하고 DB에 접근할 경우, 서버에 과부하를 일으키는 상황을 캐시 스탬피드라고 합니다.

## 해결방안
1. 적절한 만료 시간 설정
    - 적절한 만료 시간을 설정하고, 데이터 특성에 맞춰 만료 시간을 다르게 설정합니다.
2. 선 계산
    - 키가 만료되기 전에 미리 값을 갱신합니다.
3. 확률적 접근
    - 만료 시간이 가까워질수록 확률적으로 DB에 접근해 데이터를 갱신합니다.
    - TTL(Time to Live) - Random value = 남은 시간이 0보다 작은 경우, 캐시를 갱신해줍니다. 
4. PER 알고리즘
    - 확률적 조기 재계산(Probabilistic Early Recompilation) 알고리즘을 사용하여 캐시를 갱신해줍니다.
    - '확률적 접근'과의 차이점은 단순히 방법적인 차이로, 장/단점의 엄청난 차이는 없습니다.